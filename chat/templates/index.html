<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modern Discussion Forum</title>
  <style>
    /* ---------- Base & Theming ---------- */
    :root {
      --bg-grad-a: #667eea;
      --bg-grad-b: #764ba2;
      --text-1: #2d3748;
      --text-2: #4a5568;
      --text-3: #718096;
      --card: rgba(255, 255, 255, 0.95);
      --good: #48bb78;
      --bad: #f56565;
      --muted: #e2e8f0;
      --shadow-sm: 0 4px 6px rgba(0,0,0,.1);
      --shadow-md: 0 8px 16px rgba(0,0,0,.12);
      --shadow-lg: 0 12px 24px rgba(0,0,0,.15);
      --radius: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell,
        "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji",
        "Segoe UI Emoji";
      background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%);
      color: var(--text-1);
      min-height: 100vh;
      line-height: 1.45;
    }

    /* ---------- Motion preferences ---------- */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    /* ---------- Micro animations ---------- */
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pop { 0% { transform: scale(.98); } 40% { transform: scale(1.02); } 100% { transform: scale(1); } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    /* ---------- Header ---------- */
    header {
      background: var(--card);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-sm);
      padding: 1rem 2rem;
      position: sticky; top: 0; z-index: 100;
    }
    .header-content {
      max-width: 1400px; margin: 0 auto; display: flex; gap: 1rem;
      justify-content: space-between; align-items: center;
    }
    h1 {
      font-size: 1.6rem;
      background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
      letter-spacing: .3px;
    }
    nav { display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; }
    nav a {
      color: var(--text-2); text-decoration: none; padding: .55rem 1rem; border-radius: 10px;
      transition: transform .18s ease, background .18s ease, color .18s ease;
      font-weight: 600; font-size: .95rem;
    }
    nav a:hover, nav a:focus-visible {
      background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%);
      color: #fff; transform: translateY(-2px);
      outline: none;
    }
    .user-info { color: var(--text-1); font-weight: 700; }

    /* ---------- Layout ---------- */
    .container { display: flex; max-width: 1400px; margin: 2rem auto; padding: 0 2rem; gap: 2rem; }
    .sidebar { flex: 0 0 300px; position: sticky; top: 96px; height: fit-content; }
    .main { flex: 1; min-width: 0; }

    .sidebar-card {
      background: var(--card); backdrop-filter: blur(10px);
      border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.25rem; box-shadow: var(--shadow-md);
      animation: fadeInUp .35s ease both;
    }
    .sidebar-card h3 { color: var(--text-1); margin-bottom: 1rem; font-size: 1.1rem; }

    .sidebar ul { list-style: none; }
    .sidebar li { margin-bottom: .6rem; }
    .sidebar a { color: var(--bg-grad-a); text-decoration: none; display: flex; align-items: center; gap: .5rem; padding: .5rem .6rem; border-radius: 8px; transition: transform .15s ease, background .2s ease; }
    .sidebar a:hover, .sidebar a:focus-visible { background: rgba(102,126,234,.1); transform: translateX(4px); outline: none; }

    /* ---------- Search ---------- */
    .search { display: flex; gap: .6rem; margin-bottom: 1.25rem; align-items: center; }
    .search input {
      width: 100%; padding: .95rem 1.1rem; border: 2px solid var(--muted);
      border-radius: 12px; font-size: 1rem; background: var(--card);
      transition: box-shadow .2s ease, transform .2s ease, border-color .2s ease;
    }
    .search input:focus { outline: none; border-color: var(--bg-grad-a); box-shadow: 0 0 0 4px rgba(102,126,234,.16); transform: translateY(-1px); }
    .btn-primary {
      padding: .9rem 1.2rem; background: linear-gradient(135deg, var(--bg-grad-a), var(--bg-grad-b)); color: #fff;
      border: none; border-radius: 12px; cursor: pointer; font-size: .95rem; font-weight: 700;
      box-shadow: var(--shadow-sm); transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn-primary:hover, .btn-primary:focus-visible { transform: translateY(-2px); box-shadow: var(--shadow-md); filter: brightness(1.05); outline: none; }

    /* ---------- New Thread ---------- */
    .new-thread { background: var(--card); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-md); animation: fadeInUp .35s ease both; }
    .new-thread h3 { color: var(--text-1); margin-bottom: 1rem; font-size: 1.25rem; }
    .new-thread input, .new-thread textarea, .new-thread select {
      width: 100%; padding: 1rem; margin-bottom: .8rem; border: 2px solid var(--muted); border-radius: 12px;
      font: inherit; transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
    }
    .new-thread input:focus, .new-thread textarea:focus, .new-thread select:focus { outline: none; border-color: var(--bg-grad-a); box-shadow: 0 0 0 4px rgba(102,126,234,.12); transform: translateY(-1px); }
    .new-thread textarea { min-height: 120px; resize: vertical; }

    /* ---------- Threads ---------- */
    .thread { background: var(--card); border-radius: var(--radius); margin-bottom: 1rem; padding: 1.25rem; box-shadow: var(--shadow-md); transition: transform .2s ease, box-shadow .25s ease; animation: fadeInUp .35s ease both; }
    .thread:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .thread h4 { color: var(--text-1); margin-bottom: .6rem; font-size: 1.2rem; }
    .thread p { color: var(--text-2); margin-bottom: .75rem; }

    .thread-meta { display: flex; gap: .8rem; font-size: .9rem; color: var(--text-3); margin-bottom: .75rem; flex-wrap: wrap; }

    .vote-buttons { display: inline-flex; gap: .25rem; align-items: center; }
    .vote-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: .25rem .45rem; border-radius: 6px; transition: background .2s, transform .08s ease; }
    .vote-btn:hover, .vote-btn:focus-visible { background: rgba(0,0,0,.06); outline: none; }
    .vote-btn:active { transform: scale(.95); }
    .vote-btn[data-state="up"] { color: var(--good); }
    .vote-btn[data-state="down"] { color: var(--bad); }
    .vote-count { font-weight: 800; margin: 0 .35rem; min-width: 1.2rem; display: inline-block; text-align: center; }

    .replies { margin-top: 1rem; border-top: 2px solid var(--muted); padding-top: 1rem; }
    .reply { background: linear-gradient(135deg, rgba(102,126,234,.06) 0%, rgba(118,75,162,.06) 100%); padding: .85rem; margin-bottom: .75rem; border-radius: 12px; border-left: 4px solid var(--bg-grad-a); animation: fadeInUp .35s ease both; }
    .reply-author { font-weight: 700; color: var(--bg-grad-a); margin-bottom: .25rem; }

    .reply-form { margin-top: 1rem; }
    .reply-form textarea { width: 100%; padding: .85rem; border: 2px solid var(--muted); border-radius: 12px; resize: vertical; min-height: 88px; transition: border-color .2s, box-shadow .2s; }
    .reply-form textarea:focus { outline: none; border-color: var(--bg-grad-a); box-shadow: 0 0 0 4px rgba(102,126,234,.12); }
    .btn-reply { margin-top: .6rem; padding: .7rem 1.2rem; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; box-shadow: var(--shadow-sm); transition: transform .15s ease, box-shadow .2s ease, filter .2s ease; }
    .btn-reply:hover, .btn-reply:focus-visible { transform: translateY(-2px); box-shadow: var(--shadow-md); filter: brightness(1.05); outline: none; }

    /* ---------- Pagination ---------- */
    .pagination { display: flex; justify-content: center; margin: 1.25rem 0; gap: .5rem; }
    .pagination a, .pagination span { padding: .55rem 1rem; border: 1px solid var(--muted); border-radius: 8px; text-decoration: none; color: var(--text-2); background: #fff; }
    .pagination .current { background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%); color: #fff; border: none; }

    /* ---------- WebSocket status ---------- */
    #ws-status { padding: .75rem; text-align: center; border-radius: 10px; margin: .8rem 2rem; font-weight: 600; box-shadow: var(--shadow-sm); }
    .status-connected { background: rgba(72, 187, 120, .1); color: #2f855a; }
    .status-disconnected { background: rgba(245, 101, 101, .1); color: #c53030; }

    /* ---------- Chat widget ---------- */
    .chat-container {
      position: fixed; bottom: 20px; right: 20px; width: 320px; height: 420px;
      background: var(--card); backdrop-filter: blur(10px); border-radius: var(--radius);
      box-shadow: var(--shadow-lg); display: flex; flex-direction: column; z-index: 1000;
      animation: pop .4s ease both;
    }
    .chat-header { padding: .9rem 1rem; border-bottom: 1px solid var(--muted); font-weight: 800; display: flex; align-items: center; justify-content: space-between; gap: .5rem; }
    .chat-actions { display: inline-flex; gap: .35rem; }
    .icon-btn { background: transparent; border: none; cursor: pointer; padding: .3rem .45rem; border-radius: 8px; font-size: 1rem; }
    .icon-btn:hover, .icon-btn:focus-visible { background: rgba(0,0,0,.06); outline: none; }
    .chat-messages { flex: 1; padding: .8rem; overflow-y: auto; }
    .chat-message { margin-bottom: .5rem; padding: .5rem .6rem; background: #f7fafc; border-radius: 10px; }
    .chat-input { padding: .7rem; border-top: 1px solid var(--muted); display: flex; gap: .5rem; }
    .chat-input input { flex: 1; padding: .6rem .7rem; border: 1px solid var(--muted); border-radius: 10px; }

    .chat-container.min { height: auto; width: 240px; }
    .chat-container.min .chat-messages, .chat-container.min .chat-input { display: none; }

    /* ---------- Responsive ---------- */
    @media (max-width: 1024px) {
      .container { flex-direction: column; }
      .sidebar { flex: 1; position: static; }
    }
    @media (max-width: 768px) {
      .header-content { flex-direction: column; gap: .75rem; }
      .container { padding: 0 1rem; }
      .chat-container { right: 12px; bottom: 12px; width: calc(100% - 24px); height: 52vh; }
    }

    /* ---------- Nice empty states ---------- */
    .empty { border: 2px dashed var(--muted); border-radius: 12px; padding: 1rem; text-align: center; color: var(--text-3); }

    /* ---------- Subtle skeleton for first paint ---------- */
    .skeleton { background: linear-gradient(90deg, #eee 25%, #f7f7f7 37%, #eee 63%); background-size: 400% 100%; animation: shimmer 1.2s infinite; border-radius: 10px; }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1 aria-label="Discussion Forum">üí¨ Discussion Forum</h1>
      <nav>
        <a href="#home">üè† Home</a>
        <a href="{% url 'create_thread_form' %}">‚úèÔ∏è New Thread</a>
        {% if user.is_authenticated %}
          <span class="user-info" aria-live="polite">Welcome, {{ user.username }}!</span>
          <a href="{% url 'profile' %}">üë§ Profile</a>
          <a href="{% url 'notifications' %}" style="position: relative;">
            üîî Notifications
            {% if unread_notifications > 0 %}
              <span style="position:absolute;top:-8px;right:-8px;background:var(--bad);color:#fff;border-radius:50%;padding:2px 6px;font-size:.8rem;">{{ unread_notifications }}</span>
            {% endif %}
          </a>
          <a href="{% url 'logout' %}">üö™ Logout</a>
        {% else %}
          <a href="{% url 'login' %}">üîê Login</a>
          <a href="{% url 'register' %}">üìù Register</a>
        {% endif %}
      </nav>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar" aria-label="Sidebar">
      <div class="sidebar-card">
        <h3>üìÇ Categories</h3>
        <select id="category-filter" aria-label="Filter by category" onchange="filterByCategory()" style="width:100%;padding:.6rem;margin-bottom:1rem;border:1px solid var(--muted);border-radius:8px;">
          <option value="">All Categories</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>{{ category.name }}</option>
          {% endfor %}
        </select>
        <ul>
          {% for category in categories %}
            <li><a href="?category={{ category.id }}">{{ category.name }}</a></li>
          {% endfor %}
        </ul>
      </div>

      <div class="sidebar-card">
        <h3>üî• Recent Posts</h3>
        <ul id="recent-posts">
          {% for thread in page_obj|slice:":5" %}
            <li><a href="#thread-{{ thread.id }}">{{ thread.title|truncatechars:30 }}</a></li>
          {% empty %}
            <li class="empty">No threads yet</li>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <main class="main" id="main" aria-live="polite">
      <div class="search">
        <input type="text" id="search-input" placeholder="üîç Search threads..." value="{{ query }}" aria-label="Search threads" />
        <button class="btn-primary" onclick="performSearch()" aria-label="Run search">Search</button>
      </div>

      <div class="new-thread" role="region" aria-labelledby="new-thread-title">
        <h3 id="new-thread-title">‚ú® Start a New Thread</h3>
        <input type="text" id="thread-title" placeholder="Enter an interesting title..." aria-label="Thread title" />
        <select id="thread-category" aria-label="Choose a category">
          <option value="">Select Category</option>
          {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
          {% endfor %}
        </select>
        <textarea id="thread-content" placeholder="Share your thoughts with the community..." aria-label="Thread content"></textarea>
        <button class="btn-primary" onclick="createThread()">üöÄ Post Thread</button>
      </div>

      <div id="threads">
        {% for thread in page_obj %}
          <div class="thread" id="thread-{{ thread.id }}" data-id="{{ thread.id }}">
            <h4>{{ thread.title }}</h4>
            <div class="thread-meta">
              <span>üë§ {{ thread.author.username }}</span>
