{% extends "base.html" %}

{% block title %}Video Call{% endblock %}

{% block content %}
<div class="video-call-container">
    <div class="video-grid" id="videoGrid">
        <div class="video-wrapper" id="localVideo">
            <video id="localVideoElement" autoplay playsinline muted></video>
            <span class="username">You</span>
        </div>
    </div>
    
    <div class="call-controls">
        <button id="toggleAudio" class="control-btn" title="Toggle Audio">
            <span>üé§</span>
        </button>
        <button id="toggleVideo" class="control-btn" title="Toggle Video">
            <span>üìπ</span>
        </button>
        <button id="endCall" class="control-btn btn-danger" title="End Call">
            <span>üìû</span>
        </button>
        <button id="toggleScreen" class="control-btn" title="Share Screen">
            <span>üñ•Ô∏è</span>
        </button>
    </div>
</div>

<style>
    .video-call-container {
        width: 100%;
        height: 100vh;
        background: #000;
        display: flex;
        flex-direction: column;
    }
    
    .video-grid {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 10px;
        padding: 10px;
        background: #1a1a1a;
    }
    
    .video-wrapper {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .username {
        position: absolute;
        bottom: 10px;
        left: 10px;
        color: white;
        background: rgba(0,0,0,0.7);
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .call-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding: 20px;
        background: rgba(0,0,0,0.9);
    }
    
    .control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: #4CAF50;
        color: white;
        cursor: pointer;
        font-size: 1.5rem;
        transition: all 0.3s;
    }
    
    .control-btn:hover {
        background: #45a049;
        transform: scale(1.1);
    }
    
    .control-btn.btn-danger {
        background: #f44336;
    }
    
    .control-btn.btn-danger:hover {
        background: #da190b;
    }
</style>

<script>
    const callId = "{{ call_id }}";
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const socket = new WebSocket(`${wsProtocol}//${window.location.host}/ws/video-call/${callId}/`);
    
    let localStream;
    let peerConnections = {};
    const iceServers = {
        iceServers: [
            { urls: ['stun:stun.l.google.com:19302', 'stun:stun1.l.google.com:19302'] }
        ]
    };
    
    async function initLocalStream() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 1280 }, height: { ideal: 720 } },
                audio: true
            });
            document.getElementById('localVideoElement').srcObject = localStream;
        } catch (error) {
            console.error('Error accessing media devices:', error);
            alert('Please allow camera and microphone access');
        }
    }
    
    async function createPeerConnection(userId) {
        const peerConnection = new RTCPeerConnection(iceServers);
        
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });
        
        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                socket.send(JSON.stringify({
                    type: 'ice_candidate',
                    candidate: event.candidate,
                }));
            }
        };
        
        peerConnection.ontrack = event => {
            addRemoteVideo(userId, event.streams[0]);
        };
        
        peerConnections[userId] = peerConnection;
        return peerConnection;
    }
    
    function addRemoteVideo(userId, stream) {
        let videoWrapper = document.getElementById(`video-${userId}`);
        if (!videoWrapper) {
            videoWrapper = document.createElement('div');
            videoWrapper.id = `video-${userId}`;
            videoWrapper.className = 'video-wrapper';
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.playsinline = true;
            video.srcObject = stream;
            
            const username = document.createElement('span');
            username.className = 'username';
            username.textContent = `User ${userId}`;
            
            videoWrapper.appendChild(video);
            videoWrapper.appendChild(username);
            document.getElementById('videoGrid').appendChild(videoWrapper);
        }
    }
    
    socket.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'user_joined') {
            console.log(`User ${data.user_id} joined`);
        } else if (data.type === 'offer') {
            const peerConnection = await createPeerConnection(data.from_user);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.send(JSON.stringify({
                type: 'answer',
                answer: answer,
            }));
        } else if (data.type === 'answer') {
            const peerConnection = peerConnections[data.from_user];
            if (peerConnection) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
        } else if (data.type === 'ice_candidate') {
            const peerConnection = peerConnections[data.from_user];
            if (peerConnection && data.candidate) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        }
    };
    
    document.getElementById('toggleAudio').addEventListener('click', () => {
        localStream.getAudioTracks().forEach(track => {
            track.enabled = !track.enabled;
        });
    });
    
    document.getElementById('toggleVideo').addEventListener('click', () => {
        localStream.getVideoTracks().forEach(track => {
            track.enabled = !track.enabled;
        });
    });
    
    document.getElementById('endCall').addEventListener('click', () => {
        socket.send(JSON.stringify({ type: 'call_end' }));
        window.location.href = '/chat/';
    });
    
    initLocalStream();
</script>
{% endblock %}