{% extends "base.html" %}

{% block content %}
<h3>{{ call_type|capfirst }} call â€” room {{ call_id }}</h3>
<form style="display:none;">{% csrf_token %}</form>
<div id="video-area">
  <video id="localVideo" autoplay playsinline muted style="width:300px;height:200px;background:#000"></video>
  <div id="remote-videos"></div>
</div>
<button id="endCall">End</button>

<script>
const callId = "{{ call_id }}";
const callType = "{{ call_type }}";
const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
const socket = new WebSocket(wsProtocol + "//" + location.host + "/ws/video-call/" + callId + "/");

let localStream;
let peerConnection;
const configuration = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' }
  ]
};

socket.onopen = () => console.log('WS open');
socket.onmessage = (ev) => {
  const data = JSON.parse(ev.data);
  console.log('WS msg', data);
  handleSignalingData(data);
};
socket.onclose = () => console.log('WS closed');

document.getElementById('endCall').addEventListener('click', async () => {
  const resp = await fetch("{% url 'end_call' 0 %}".replace('/0/','/'+callId+'/'), {
    method: 'POST',
    headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''}
  });
  const j = await resp.json();
  if (j.success) {
    socket.send(JSON.stringify({ type: 'call_end' }));
    window.location.href = "{% url 'chat_home' %}";
  }
});

async function initMedia(){
  try {
    if (callType === 'video') {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('localVideo').srcObject = localStream;
    } else {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      document.getElementById('localVideo').style.display = 'none';
    }
    initPeerConnection();
  } catch (e) {
    console.error('media error', e);
    alert('Please allow camera/microphone to proceed with the call.');
  }
}

function initPeerConnection() {
  peerConnection = new RTCPeerConnection(configuration);

  localStream.getTracks().forEach(track => {
    peerConnection.addTrack(track, localStream);
  });

  peerConnection.onicecandidate = (event) => {
    if (event.candidate) {
      socket.send(JSON.stringify({
        type: 'ice_candidate',
        candidate: event.candidate
      }));
    }
  };

  peerConnection.ontrack = (event) => {
    const remoteVideo = document.createElement('video');
    remoteVideo.srcObject = event.streams[0];
    remoteVideo.autoplay = true;
    remoteVideo.playsinline = true;
    remoteVideo.style.width = '300px';
    remoteVideo.style.height = '200px';
    remoteVideo.style.background = '#000';
    document.getElementById('remote-videos').appendChild(remoteVideo);
  };

  // Create offer if caller
  if ("{{ is_caller }}" === "True") {
    createOffer();
  }
}

async function createOffer() {
  try {
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.send(JSON.stringify({
      type: 'offer',
      offer: offer
    }));
  } catch (e) {
    console.error('Error creating offer:', e);
  }
}

async function handleSignalingData(data) {
  try {
    if (data.type === 'offer') {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      socket.send(JSON.stringify({
        type: 'answer',
        answer: answer
      }));
    } else if (data.type === 'answer') {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
    } else if (data.type === 'ice_candidate') {
      await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    } else if (data.type === 'call_ended') {
      alert('Call ended by other participant');
      window.location.href = "{% url 'chat_home' %}";
    }
  } catch (e) {
    console.error('Error handling signaling data:', e);
  }
}

initMedia();
</script>
{% endblock %}
